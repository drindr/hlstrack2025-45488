# FPGA创新设计大赛 AMD赛道命题式赛道 - 设计报告
Group : 45488
---

## 1. 项目概述

### 1.1 项目背景

本项目面向嵌入式可编程逻辑（FPGA）上的通用加速场景，选取线性代数（Cholesky）、加密哈希（SHA‑224/256）、通用无损压缩（LZ/LZ4）四类典型算子进行高层次综合（HLS）优化，重点验证吞吐率、时延、片上存储与面积之间的平衡与工程化落地方法。
### 1.2 设计目标

- 功能目标：
    - 支持连续数据流的 SHA‑224/256 摘要计算，帧间无气泡；
    - 支持 LZ 与 LZ4 流式压缩，提供可配置窗口与分块大小。
    - 支持定点/浮点可配的 Cholesky 分解（下三角），数值稳定；

- 性能目标：

    - 顶层 ap_ctrl_none/axis 流水，II=1 或等效单拍摄取；

    - SHA‑224/256：512-bit block/64cycle（或更优），吞吐 ≥ 1 block/66cycle；

    - LZ/LZ4：压缩吞吐 ≥ 输入时钟 0.8 字/拍，压缩率 ≥ 1.4×（测试集）。
    - Cholesky：矩阵 N×N，目标吞吐 ≥ 1 元素/拍，主环 II ≤ 2；

- 资源优化目标：

    - BRAM 利用率 ≤ 60%，URAM=0（PYNQ‑Z2 无 URAM）；

    - DSP 约束 ≤ 40；LUT/FF 在 85% 容量内。

### 1.3 技术规格

- **目标平台：** AMD PYNQ-Z2
- **开发工具：** Vitis HLS 2024.2
- **编程语言：** C/C++
- **验证环境：** C/RTL Cosim + C Test驱动，随机与边界用例，文件/AXIS 回环

---

## 2. 设计原理和功能框图

### 2.1 算法原理



**SHA‑224/256：**
基于 Merkle–Damgård 结构，输入分块 512 bit，64 轮压缩，消息调度 `W[0..63]`，工作变量 `a..h` 迭代。

**LZ/LZ4：**滑动窗口 + 最长匹配，哈希/字典定位候选，匹配-复制-字面量交替输出。LZ4 使用**固定字典哈希 + 可变长 token**以降低开销。

**Cholesky 分解（A 为对称正定）：**

目标：将实对称正定矩阵分解为下三角矩阵与其转置的乘积。
  
$$
A = L\,L^{\top}
$$

对角与非对角元素递推：
  
$$
L_{ii} = \sqrt{\,A_{ii} - \sum_{k=1}^{i-1} L_{ik}^2\,},\quad
L_{ji} = \frac{A_{ji} - \sum_{k=1}^{i-1} L_{jk} L_{ik}}{L_{ii}},\quad j>i.
$$


**核心算法公式：**

$$
A = L L^{T}, \quad 
L_{ii} = \sqrt{A_{ii} - \sum_{k=1}^{i-1} L_{ik}^2}, \quad
L_{ji} = \frac{A_{ji} - \sum_{k=1}^{i-1} L_{jk} L_{ik}}{L_{ii}}, \quad j>i
$$


### 2.2 系统架构设计

#### 2.2.1 顶层架构


```text
┌─────────────────────────────────────────────────────┐
│                      顶层设计（Dataflow）            │
├─────────────┬──────────────┬──────────────┬───────────┤
│  输入模块   │  预处理/PACK  │   计算核心    │  输出模块  │
│ (AXIS in)   │ (对齐/缓存)   │ (核内流水)    │ (AXIS out) │
└─────────────┴──────────────┴──────────────┴───────────┘
                ↑  BRAM/Stream 缓冲（Ping-Pong/Depth）  

```

#### 2.2.2 核心计算模块设计

**模块功能说明：**
- SHA Core：消息调度与 64 轮压缩解耦，W 产生与轮函数并行；寄存器阵列 + 完全展开 64 路（或滚动 8/16 路）。
- LZ/LZ4 Core：哈希查找、候选比较、输出编码拆分为 3 Stage，跨 Stage 使用 hls::stream 解耦。
- Cholesky Core：列主循环 i 外层，行环 j + 累加 k 内层；采用分块/Tile 化与部分展开，sqrt 走 DSP + CORDIC/浮点核。

#### 2.2.3 数据流图

```
输入 → 对齐/分块 → 核心流水 → 尾部整理 → 输出
           │           │            │
        (AXIS)       (Dataflow)   (AXIS)
```

### 2.3 接口设计

- 输入接口： AXI4‑Stream，TDATA 可配置（32/64/128b），TLAST 分帧；

- 输出接口： AXI4‑Stream，同步 TLAST；

- 存储接口： AXI4‑Master（突发读写，64B 对齐），内部使用 BRAM Ping‑Pong；

- 控制接口： ap_ctrl_none 或 ap_ctrl_hs，参数通过 AXI‑Lite。

---

## 3. 优化方向选择与原理

### 3.1 优化目标分析

根据赛题要求，本设计主要关注以下优化方向：

- [ ] 减少片上存储（BRAM）使用
- [ ] 提升流水线性能（降低 II / 提高吞吐率）
- [ ] 提高性能/资源比（MACs/DSP 或 throughput/BRAM）

### 3.2 优化策略设计

#### 3.2.1 存储优化

**优化原理：**
 利用层次化缓存 + 数据复用降低对 BRAM 的压力；通过 ARRAY_PARTITION / BIND_STORAGE 将随机访问寄存器化；用 宽总线突发减少外设等待。

**具体措施：**

- 读写对齐：外设端 64/128bit 宽突发，内部打包/解包；

- 关键数组寄存器化：`#pragma HLS ARRAY_PARTITION variable=W complete`（SHA）、`L[i][k]` 行内分块（Cholesky）；

- 字典窗口裁剪：LZ/LZ4 将哈希表移至 LUTRAM，命中链存于 BRAM。

#### 3.2.2 流水线优化

**优化原理：**
在循环间用 `DATAFLOW `解耦，在循环内以` PIPELINE `控 `II`，在计算‑访存间以 Ping‑Pong 缓冲隐藏延迟。

**具体措施：**

- PIPELINE II=1：消息调度、轮函数计算、比较器阵列；

- UNROLL：SHA 轮函数 8/16/64 级；Cholesky 内积环按 `factor=4..8`；

- 依赖消除：`DEPENDENCE false`、`LATENCY` 绑定 `sqrt`；

- 函数内联：短小轮操作、哈希函数 `inline`，减少函数调用开销。

#### 3.2.3 并行化优化

**优化原理：**
任务级（多核分帧）、数据级（字向量化）、指令级（轮函数并行）。

**具体措施：**

- 多核分帧：LZ4/LZ 以帧为粒度并行多个核；

- 向量化：AXIS 宽度提升至 64/128bit，内部使用 ap_uint<128>；

- 选择性完全展开：SHA 64 路全展开版本作为高吞吐配置。

### 3.3 HLS指令优化

```cpp
// 示例HLS优化指令
#pragma HLS DATAFLOW
#pragma HLS PIPELINE II=1
#pragma HLS UNROLL factor=8
#pragma HLS ARRAY_PARTITION variable=W complete dim=1
#pragma HLS BIND_STORAGE variable=hash_tab type=ram_s2p impl=bram
#pragma HLS DEPENDENCE variable=acc inter false
#pragma HLS STREAM variable=fifo depth=64
#pragma HLS INLINE
```

---

## 4. LLM 辅助优化记录

### 4.1 优化阶段一：[阶段名称]

#### 4.1.1 优化目标

[描述这个阶段的具体优化目标]

#### 4.1.2 Prompt 设计

**用户输入：**

```
[在此粘贴发送给LLM的完整prompt]
例如：
我正在使用Vitis HLS优化一个卷积神经网络加速器。当前的设计在PYNQ-Z2平台上
的初始化间隔(II)为8，BRAM使用率为85%。请帮我分析如何通过循环展开和数组
分割来降低II并减少BRAM使用量。

当前代码如下：
[代码片段]

请提供具体的优化建议和HLS指令。
```

#### 4.1.3 LLM 回答

**模型回答：**

```
[在此粘贴LLM的完整回答]
```

#### 4.1.4 优化实施

**采用的建议：**
[列出实际采用的优化建议]

**代码修改：**

```cpp
// 优化前代码
[原始代码片段]

// 优化后代码  
[修改后的代码片段]
```

**实施效果：**

- II改善：[从X降低到Y]
- BRAM使用改善：[从X%降低到Y%]
- 其他改善：[描述]

### 4.2 优化阶段二：[阶段名称]

#### 4.2.1 优化目标

[描述第二阶段的优化目标]

#### 4.2.2 Prompt 设计

**用户输入：**

```
[第二轮优化的prompt]
```

#### 4.2.3 LLM 回答

**模型回答：**

```
[LLM的回答]
```

#### 4.2.4 优化实施

[按照4.1.4的格式填写]

### 4.3 优化阶段三：[如有更多阶段，继续添加]

### 4.4 LLM 辅助优化总结

**总体收益：**

- 性能提升：[具体数值]
- 资源节省：[具体数值]
- 开发效率：[描述LLM如何提高开发效率]

**经验总结：**

- 有效的prompt设计要点：[总结]
- LLM建议的可行性分析：[总结]
- 需要人工验证的关键点：[总结]

---

## 5. 优化前后性能与资源对比报告

### 5.1 测试环境

- **硬件平台：** AMD PYNQ-Z2
- **软件版本：** Vitis HLS 2024.2
- **测试数据集：** [描述测试数据]
- **评估指标：** Latency，Estimated_Clock_Period

### 5.2 综合结果对比


#### 5.2.1 性能指标对比
##### sha256
| 性能指标                 | 优化前       | 优化后        | 改善幅度     |
| -------------------- | --------- | ---------- | -------- |
| **延迟(Latency)**      | 809      | 1156   |    -42.8%    |
| **时钟周期(Estimated_Clock_Period)**        | 12.882 ns  | 7.656 ns   | 31.6%   |
| **执行时间（Estimated_Execution_Time）**        | 10421.5 ns  | 8850.3ns   | 15.1%   |
| **时钟频率**             | 66.7 MHz | 111.1 MHz  | 40.0%   |


##### lz4_compress
| 性能指标                 | 优化前       | 优化后        | 改善幅度     |
| -------------------- | --------- | ---------- | -------- |
| **延迟(Latency)**      | 3390     | 2520   |    25.6%    |
| **时钟周期(Estimated_Clock_Period)**  | 13.220 ns  | 13.243 ns   | 0.0%   |
| **执行时间（Estimated_Execution_Time）**        | 44815.8 ns  | 33372.3ns   | 25.5%   |
| **时钟频率**             | 66.7 MHz | 66.7 MHz  | 0.0%   |

##### Cholesky
| 性能指标                 | 优化前       | 优化后        | 改善幅度     |
| -------------------- | --------- | ---------- | -------- |
| **延迟(Latency)**      | 4919     | 2391   |    51.4%    |
| **时钟周期(Estimated_Clock_Period)**  | 6.276ns  | 6.281 ns   | 0.0%   |
| **执行时间（Estimated_Execution_Time）**        | 30871.6 ns  | 15017.9ns   | 51.4%   |
| **时钟频率**             | 142.9 MHz | 142.9 MHz  | 0.0%   |




### 5.4 正确性验证

#### 5.4.1 C代码仿真结果

**仿真配置：**

- 测试用例数量：[数量]
- 测试数据类型：[描述]
- 精度要求：[描述]

**仿真结果：**

- 功能正确性：✅ 通过 / ❌ 未通过
- 输出精度：[具体精度指标]
- 性能验证：[描述]

#### 5.4.2 联合仿真结果

**仿真配置：**

- RTL仿真类型：[Verilog/VHDL]
- 时钟周期：[ns]
- 仿真时长：[周期数]

**仿真结果：**

- 时序正确性：✅ 通过 / ❌ 未通过
- 接口兼容性：✅ 通过 / ❌ 未通过
- 性能匹配度：[%]

#### 5.4.3 硬件验证（如适用）

[如果进行了板级验证，在此描述验证过程和结果]

---

## 6. 创新点总结

### 6.1 技术创新点

[列出本设计的主要技术创新点]

1. **创新点1：** [描述]
2. **创新点2：** [描述]
3. **创新点3：** [描述]

### 6.2 LLM辅助方法创新

[描述在LLM辅助优化方面的创新方法]

---

## 7. 遇到的问题与解决方案

### 7.1 技术难点

| 问题描述 | 解决方案    | 效果       |
| -------- | ----------- | ---------- |
| [问题1]  | [解决方案1] | [效果描述] |
| [问题2]  | [解决方案2] | [效果描述] |

### 7.2 LLM辅助过程中的问题

[描述在使用LLM过程中遇到的问题和解决方法]

---

## 8. 结论与展望

### 8.1 项目总结

[总结项目的完成情况和主要成果]

### 8.2 性能达成度

[对照最初设定的目标，分析达成情况]

### 8.3 后续改进方向

[描述可能的进一步优化方向]

---

## 9. 参考文献

[1] [参考文献1]
[2] [参考文献2]
[3] [参考文献3]

---

